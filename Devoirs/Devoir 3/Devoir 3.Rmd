---
title: |
  STT 3260  
  Devoir 3
author: "Mathieu Lemire"
date: "17 Octobre 2025"
output: pdf_document
---

```{r}
library(survival)
```

# Exercice 1

## a)

## Estimations des paramètres pour le groupe 0

Pour le groupe 0, on a

```{r}
data <- read.table("C:/Users/14385/Desktop/A25/STT 3260/Devoirs/Devoir 3/kidney.txt",
                    header=TRUE)

groupe_0_weib <- survreg(Surv(time, delta) ~ 1, 
                         data = data[data$type == 2,], 
                         dist = "weibull")
summary(groupe_0_weib)
```

## Estimation de $\LARGE\alpha_0$

On a $$\log(\hat{\sigma}_0) = 0.616 \implies \hat{\sigma}_0 = \exp(0.616) \approx 1.852$$ Comme $\sigma = \dfrac{1}{\alpha}$, on a $\alpha = \dfrac{1}{\sigma}$. On calcule $\hat{\alpha}_0$ $$\hat{\alpha}_0 = \frac{1}{\hat{\sigma}_0} = \frac{1}{1.852} \approx 0.54$$

```{r}
mu_0 <- unname(groupe_0_weib$coefficients)
sigma_0 <- groupe_0_weib$scale
alpha_0 <- 1/sigma_0
alpha_0
```

## Écart type de $\LARGE \hat{\alpha}_0$

On doit utiliser la méthode delta: 
$$
\widehat{Var(g(\hat{\beta}))} = (g'(\hat{\beta}))^2 Var(\hat{\beta}) \implies \sqrt{\widehat{Var(g(\hat{\beta}))}} = \left|g'(\hat{\beta}) \right| \sqrt{Var(\hat{\beta})}
$$

Puisque la relation entre $\log(\sigma) \text{ et } \alpha$ est $\alpha = g(\log(\sigma))  = \exp(-\log(\sigma) )$, on a : $$\frac{\hat{\alpha}}{d(\log\hat{\sigma})} = - \exp(-\log(\hat{\sigma}))$$

\begin{align*}
\widehat{SE(\hat{\alpha}_0)}=
\sqrt{\widehat{Var(\hat{\alpha}_0)}}  &= \left|\frac{\hat{\alpha}_0}{d(\log\hat{\sigma}_0)}\right| \sqrt{Var(\log\hat{\sigma}_0)}\\
&= \Big|- \exp(-\log(\hat{\sigma}_0))\Big| \sqrt{Var(\log\hat{\sigma}_0)}\\
&= \Big|- \hat{\alpha}_0 \;\Big| \sqrt{Var(\log\hat{\sigma}_0)}\\
&\approx \Big|- 0.54 \;\Big|\times 0.265 \\
&= 0.1431
\end{align*}

## Estimation de $\LARGE\lambda_0$

La relation entre $\mu$ et $\lambda$ est $\mu = \dfrac{-\log(\lambda)}{\alpha} \implies \lambda = \exp(-\alpha\mu)$. Puisque $\hat{\mu}_0 = 5.411$, on a $$\hat{\lambda}_0 = \exp(-\hat{\alpha}_0\hat{\mu}_0) =
\exp(-0.54 \times 5.411) \approx  0.0538$$

```{r}
lambda_0 <- exp(-alpha_0 * mu_0)
lambda_0 <- unname(lambda_0)
lambda_0
```

## Écart type de $\LARGE \hat{\lambda}_0$

On pose $\eta =\log(\sigma)$, ce qui implique que $\lambda = \exp\left(-\frac{\mu}{\sigma}\right) = \exp\left(-\mu \exp(-\log\mu) \right) = \exp\left(-\mu e^{-\eta} \right)$.

On calcule les dérivées de $\lambda = g(\mu,\eta)$ : $$\dfrac{\partial\lambda}{\partial\mu} = - e^{-\eta}\exp(-\mu e^{-\eta}) = -\lambda e^{-\eta} \quad  \quad \quad
\dfrac{\partial\lambda}{\partial\eta} = \mu e^{-\eta}\exp(-\mu e^{-\eta}) = \lambda \mu e^{-\eta}$$

On calcule la variance estimée de $\hat{\lambda}$

$$\widehat{Var(\hat{\lambda})} =
\begin{pmatrix}
\dfrac{\partial\hat{\lambda}}{\partial\hat{\mu}} &
\dfrac{\partial\hat{\lambda}}{\partial\hat{\eta}}
\end{pmatrix}
\begin{pmatrix}
Var(\hat{\mu}) & Cov(\hat{\mu}, \hat{\eta}) \\
Cov(\hat{\mu}, \hat{\eta}) & Var(\hat{\eta})
\end{pmatrix}
\begin{pmatrix} 
\dfrac{\partial\hat{\lambda}}{\partial\hat{\mu}} \\
\dfrac{\partial\hat{\lambda}}{\partial\hat{\eta}}
\end{pmatrix}$$

```{r}
eta_0 <- log(sigma_0)
vecteur_der_0 <-c(-lambda_0*exp(-eta_0) , lambda_0*mu_0 *exp(-eta_0))
vecteur_der_0
```

```{r}
matrice_var_0 <- groupe_0_weib$var
matrice_var_0
```

```{r}
var_lamda_0 <- as.numeric(t(unname(vecteur_der_0)) %*% unname(matrice_var_0) %*% unname(vecteur_der_0))
var_lamda_0
```

Donc $\widehat{Var(\hat{\lambda}_0)} \approx 0.0005427$ et l'écart type estimé est

```{r}
std_err_lambda_0 <- as.numeric(sqrt(var_lamda_0))
std_err_lambda_0
```

Donc $\widehat{SE(\hat{\lambda}_0)} \approx 0.0233$

## Estimations des paramètres pour le groupe 1

```{r}
groupe_1_weib <- survreg(Surv(time, delta) ~ 1, data = data[data$type == 1,], dist = "weibull")
summary(groupe_1_weib)
```

## Estimation de $\LARGE\alpha_1$

On a $$\log(\hat{\sigma}_1) = -0.467 \implies \hat{\sigma}_1 = \exp(-0.467 ) \approx 0.627 \implies \hat{\alpha}_1 = \frac{1}{\hat{\sigma}_1} = \frac{1}{0.627} \approx 1.595$$

```{r}
mu_1 <- unname(groupe_1_weib$coefficients)
sigma_1 <- groupe_1_weib$scale
alpha_1 <- 1/sigma_1
alpha_1
```

## Écart type de $\LARGE \hat{\alpha}_1$

\begin{align*}
\widehat{SE(\hat{\alpha}_1)}
&= \Big|- \hat{\alpha}_1 \;\Big| \sqrt{Var(\log\hat{\sigma}_1)}\\
&\approx \Big|- 1.595 \;\Big|\times 0.203 \\
&= 0.323785
\end{align*}

## Estimation de $\LARGE\lambda_1$

Puisque $\hat{\mu}_1 = 3.194$, on a $$ \hat{\lambda}_1 = \exp(-\hat{\alpha}_1\hat{\mu}_1) =
\exp(-1.595 \times 3.194) \approx  0.00613$$

```{r}
lambda_1 <- exp(-alpha_1 * mu_1)
lambda_1 <- unname(lambda_1)
lambda_1
```

## Écart type de $\LARGE\hat{\lambda}_1$

On calcule en premier les dérivés partielles de $\hat{\lambda}_1$ par rapport à $\eta_1$ et par rapport à $\mu_1$

```{r}
eta_1 <- log(sigma_1)
vecteur_der_weib_1 <-c(-lambda_1*exp(-eta_1) , lambda_1*mu_1 *exp(-eta_1))
vecteur_der_weib_1
```

La matrice de covariance $Cov(\hat{\mu}, \hat{\eta})$ est

```{r}
matrice_var_1 <- groupe_1_weib$var
matrice_var_1
```

On calcule à présent $Var(\hat{\lambda}_1)$

```{r}
var_lambda_1 <- as.numeric(t(vecteur_der_weib_1) %*% matrice_var_1 %*% vecteur_der_weib_1)
var_lambda_1
```

On calcule maintenant l'écart type

```{r}
std_err_lambda_1 <- sqrt(var_lambda_1)
std_err_lambda_1
```

On a $\widehat{SE(\hat{\lambda}_1)} = 0.00577$

## b)

On teste l'hypothèse que $\alpha = 1$ pour chacun des groupe. On pose $$H_0: \alpha = 1 \quad\quad H_1:\alpha \not=1$$ Mais puisqu'on a $\alpha = \dfrac{1}{\sigma} \implies \log(\alpha) = -\log(\sigma)$ et pour $\alpha = 1 \implies \log(\sigma) = 0$ On avait déjà posé plus haut que $\eta = \log(\sigma)$. Nos hypothèses sont alors: $$H_0:\eta = 0 \quad \quad H_1:\eta\not=0$$

## Tests pour le groupe 0

On rappel la sortie:

```{r}
summary(groupe_0_weib)
```

## Test de Wald

La statistique de Wald est déjà calculer, $W=2.32$ et la p-valeur associé à la statistique de Wald pour $\eta$ est de $0.02<0.05$. On peut rejetter l'hypothèse nulle au niveau 5% mais nous ne pouvons pas rejetter l'hypothèse nulle au niveau 1%

## Test du rapport de vraisemblance

Pour $\alpha=1$ la distribution Weibull$(\alpha,\lambda)$ suit une distribution Exponentielle$(\lambda)$. On peut faire l'ajustement avec l'exponentielle et faire le test du rapport de vraisemblance puisque l'Exponentielle$(\lambda)$ est emboîté dans la Weibull$(\alpha =1,\lambda)$

```{r}
groupe_0_exp <- survreg( Surv(time, delta) ~1, 
                         data = data[data$type == 2,],
                         dist = "exp")
summary(groupe_0_exp)
```

On calcule la statistitque de test: $$\Lambda = -2 [\ell(\alpha_0 =1, \hat{\lambda}_0) - \ell(\hat{\alpha}_0,\hat{\lambda}_0)] \approx -2[-55.1 - (-51.6)] = 7$$ 

Nous avons un paramètre de différent entre les modèles donc on calcule la valeur-p avec une $\chi_1^2$. La valeur-p est $$\mathbb{P}(\chi_1^2 \ge7) = 0.008150972$$

```{r}
valeur_p_rap_vrai_groupe_0 <-pchisq(7,1,lower.tail = FALSE)
names(valeur_p_rap_vrai_groupe_0) <- "Valeur-p"
valeur_p_rap_vrai_groupe_0
```

On rejette l'hypothèse nulle au niveau 1%

## Tests pour le groupe 1

On rappel la sortie:

```{r}
summary(groupe_1_weib)
```

## Test de Wald

La statistique de Wald est donc $W=-2.3$ et la valeur-p associé au test de Wald pour $\eta_1$ est $\text{valeur-p}=0.021$. On a les mêmes conclusions que pour le groupe 0, on rejette l'hypothèse nulle au niveau de confiance maximale de 3%.

## Test du rapport de vraisemblance

On calcule le modèle exponentielle pour le groupe 1

```{r}
groupe_1_exp <- survreg( Surv(time, delta) ~ 1, 
                         data = data[data$type == 1,],
                         dist = "exp")
summary(groupe_1_exp)
```

On calcule la statistitque de test: $$\Lambda = -2 [\ell(\alpha_1 =1, \hat{\lambda}_1) - \ell(\hat{\alpha}_1,\hat{\lambda}_1)] \approx -2[-67.2 - (-65)] = 4.4$$ La valeur-p est $$\mathbb{P}(\chi_1^2 \ge 4.4) = 0.008150972$$

```{r}
pchisq(4.4, 1, lower.tail = FALSE)
```

On rejette l'hypothèse nulle au niveau 5% mais encore une fois on ne peut la rejetter au niveau 1%.

## d)

On veut tester si la mise en place du cathérer n'a aucun effet avec $Z$ la variable indicatrice qui vaut 1 si l'individu appartient au groupe 1 et 0 sinon. Puisque dans le modèle on a $\gamma Z$, on a les hypothèses: $$H_0: \gamma = 0 \quad \quad H_1: \gamma \not = 0$$

```{r}
data$Z <- data$type - 1
reg_weib_cov <- survreg(Surv(time=time,event=delta)~Z, data=data, dist="weibull")
summary(reg_weib_cov)
```

La statistique de Wald pour Z est $W_Z = 1.33$ avec une valeur-p associé = $0.18$ On ne rejette pas l'hypothèse nulle, même au niveau de signification 15%.

On calcule $h(t|Z)$ pour un modèle de defaillance accéléré Weibull: \begin{align*}
h(t|Z) &= h_o(te^{-\gamma Z}) e^{-\gamma Z} \\
&= \alpha\lambda(te^{-\gamma Z})^{\alpha - 1}e^{-\gamma Z} \\
&= \alpha\lambda t^{\alpha -1} e^{-\alpha\gamma Z}
\end{align*}

$$
h(t|Z=0) = \alpha\lambda t^{\alpha -1}  \quad \quad  h(t|Z=1) = \alpha\lambda t^{\alpha -1}e^{-\alpha\gamma}
$$ 

Le risque relatif est: $$RR(t) = \frac{h(t|Z=1)}{h(t|Z=0)} = \frac{\alpha\lambda t^{\alpha -1}e^{-\alpha\gamma}}{\alpha\lambda t^{\alpha -1}} = e^{-\alpha \gamma}$$

Qui ne dépend pas de $t$

On calcule l'estimation du risque relatif: $$\widehat{RR} = \exp(-\hat{\alpha}\hat{\gamma}) = \exp\left(-\frac{\hat{\gamma}}{\hat{\sigma}}\right) = \exp\left( -\frac{0.623}{1.14}\right) \approx 0.579$$ Pour construire l'intervalle de confiance pour le risque relatif estimé, il faut utiliser la méthode delta

On réécrit RR en fonction de $\eta = \log(\sigma)$ puisque $\alpha = \exp(-\log(\sigma)) \implies \alpha = \exp(-\eta) \implies RR = \exp(-e^{-\eta} \gamma)$ 

$$\frac{\partial RR}{\partial \mu} = 0 \quad \quad \frac{\partial RR}{\partial \gamma} = -e^{-\eta}RR = -\frac{RR}{\sigma}  \quad \quad\frac{\partial RR}{\partial \eta} = e^{-\eta}\gamma RR = \frac{\gamma RR}{\sigma}$$ 
La matrice de covariance de $(\hat{\mu},\hat{\gamma}, \hat{\eta})$ est
```{r}
matrice_cov <- reg_weib_cov$var
dimnames(matrice_cov) <- list(c("mu","gamma","eta"),
                              c("mu","gamma","eta"))
matrice_cov
```
Le vecteur gradient est
```{r}
sigma_reg <- reg_weib_cov$scale
gamma_reg <- reg_weib_cov$coefficients[2]
RR <- exp(-gamma_reg/sigma_reg)
vecteur_gradient <- c(0, -RR/sigma_reg, (gamma_reg* RR) / sigma_reg)
names(vecteur_gradient) <- c("Der(RR/mu)", "Der(RR/gamma)", "Der(RR/eta)")
vecteur_gradient
```
```{r}
variance_RR <- as.numeric(t(vecteur_gradient) %*% matrice_cov %*% vecteur_gradient)
names(variance_RR) <- "Var(RR)"
variance_RR
```

Donc$\widehat{Var}(\widehat{RR}) = 0.0528$

L'intervalle de confiance de 95% pour $\widehat{RR}$ est
```{r}
cat("\n", "IC de 95% pour RR", "\n")
IC_RR <- RR + c(-1,1) * qnorm(0.975) * sqrt(variance_RR)
names(IC_RR) <- c("IC_inf", "IC_sup")
IC_RR
```
Puisque $RR = 0.578$ le groupe 1 est moins à risque en moyenne mais on n'observe 
pas une différence significative au niveau 95% car 1 est inclue dans l'intervalle de confiance


Le facteur d'accélération est $e^{-\hat{\gamma}} = 0.5364685$
```{r}
facteur_acc <- exp(-gamma_reg)
names(facteur_acc) <- "Facteur d'accélération"
facteur_acc
```
Un intervalle de confiance de 95% pour le facteur d'accélération est
```{r}
cat("\n", "IC de 95% pour RR", "\n")
IC_gamma_neg <- -gamma_reg + c(-1,1)*qnorm(0.975)*0.469
IC_fac_acc <-  exp(IC_gamma_neg)
names(IC_fac_acc) <- c("IC_inf", "IC_sup")
IC_fac_acc
```
Puisque le facteur d'accélération est 0.5364, le temps est accélérer pour le groupe 1
par rapport au groupe 0. Puisque 1 est dans l'intervalle de confiance, on n'observe pas une
différence significative au niveau 95%.

# Exercice 2

## Estimations des paramètres pour le groupe 0

Pour le groupe 0, on a

```{r}
groupe_0_logLogistique <- survreg(Surv(time, delta) ~ 1, 
                         data = data[data$type == 2,], 
                         dist = "loglogistic")
summary(groupe_0_logLogistique)
```

Puisque la log-logistique à les même relations entre leurs paramètres que la Weibull on procède de la même façon

```{r}
mu_log_0 <- unname(groupe_0_logLogistique$coefficients)
sigma_log_0 <- groupe_0_logLogistique$scale
alpha_log_0 <- 1/sigma_log_0
names(alpha_log_0) <- "alpha"
alpha_log_0
```

\begin{align*}
\widehat{SE(\hat{\alpha}_0)} &= \Big|- \hat{\alpha}_0 \;\Big| \sqrt{Var(\log\hat{\sigma}_0)}\\
&\approx \Big|- 0.576 \;\Big|\times 0.261 \\
&= 0.150336
\end{align*}

```{r}
lambda_log_0 <- exp(-alpha_log_0 * mu_log_0)
names(lambda_log_0) <- "lambda"
lambda_log_0
```

```{r}
eta_log_0 <- log(sigma_log_0)
vecteur_der_0 <-c(-lambda_log_0*exp(-eta_log_0) , lambda_log_0*mu_log_0 *exp(-eta_log_0))
names(vecteur_der_0) <- c("der(lambda/mu)", "der(lambda/eta)")
vecteur_der_0
```

```{r}
matrice_var_0 <- groupe_0_logLogistique$var
dimnames(matrice_var_0) <- list(c("mu", "eta"), c("mu", "eta"))
matrice_var_0
```

```{r}
var_log_lambda_0 <- as.numeric(t(vecteur_der_0) %*% matrice_var_0 %*% vecteur_der_0)
names(var_log_lambda_0) <- "Var(lambda)"
var_log_lambda_0
```

```{r}
std_err_lambda_log_0 <- sqrt(var_log_lambda_0)
names(std_err_lambda_log_0) <- "SE(lambda)"
std_err_lambda_log_0
```

## Estimations des paramètres pour le groupe 1

```{r}
groupe_1_logLogistique <- survreg(Surv(time, delta) ~ 1, 
                         data = data[data$type == 1,], 
                         dist = "loglogistic")
summary(groupe_1_logLogistique)
```

```{r}
mu_log_1 <- unname(groupe_1_logLogistique$coefficients)
sigma_log_1 <- groupe_1_logLogistique$scale
alpha_log_1 <- 1/sigma_log_1
names(alpha_log_1) <- "alpha"
alpha_log_1
```

\begin{align*}
\widehat{SE(\hat{\alpha}_1)}&= \Big|- \hat{\alpha}_1 \;\Big| \sqrt{Var(\log\hat{\sigma}_1)}\\
&\approx \Big|- 1.8557 \;\Big|\times 0.206  \\
&= 0.38227
\end{align*}

```{r}
lambda_log_1 <- exp(-alpha_log_1 * mu_log_1)
names(lambda_log_1) <- "lambda"
lambda_log_1
```

```{r}
eta_log_1 <- log(sigma_log_1)
vecteur_der_1 <-c(-lambda_log_1*exp(-eta_log_1) , lambda_log_1*mu_log_1 *exp(-eta_log_1))
names(vecteur_der_1) <- c("der(lambda/mu)", "der(lambda/eta)")
vecteur_der_1
```

```{r}
matrice_var_1 <- groupe_1_logLogistique$var
dimnames(matrice_var_1) <- list(c("mu", "eta"), c("mu", "eta"))
matrice_var_1
```

```{r}
var_log_lambda_1 <- as.numeric(t(vecteur_der_1) %*% matrice_var_1 %*% vecteur_der_1)
names(var_log_lambda_1) <- "Var(lambda)"
var_log_lambda_1
```

```{r}
std_err_lambda_log_1 <- sqrt(var_log_lambda_1)
names(std_err_lambda_log_1) <- "SE(lambda)"
std_err_lambda_log_1
```

# Tests de Wald

Les hypothèses sont encore $$H_0:\eta = 0 \quad \quad H_1:\eta\not=0$$

## Groupe 0

```{r}
summary(groupe_0_logLogistique)
```

La statistique de Wald est $W_{\eta_0} = 2.11$ avec la valeur-p associé = 0.035. Encore une fois on ne peut pas rejetter l'hypothèse au niveau 1% mais on peut le faire au niveau 5%.

## Groupe 1

```{r}
summary(groupe_1_logLogistique)
```

La statistique de Wald est $W_{\eta_1} = -3.01$ avec la valeur-p associé = 0.0026. On rejette l'hypothèse nulle au niveau 0.5%

## d)

On calcule $h(t|Z)$ pour un modele de defaillance accéléré Log-logistique: 

\begin{align*}
h(t|Z) &= h_o(te^{-\gamma Z}) e^{-\gamma Z} \\
&= \frac{\alpha (te^{-\gamma Z})^{\alpha - 1} \lambda}{1 + \lambda (te^{-\gamma Z})^\alpha} e^{-\gamma Z} \\
&= \frac{\alpha t^{\alpha - 1}e^{-\alpha\gamma Z} \lambda}{1 + \lambda t^\alpha e^{-\alpha\gamma Z}}
\end{align*}

$$
h(t|Z=0) = \frac{\alpha \lambda t^{\alpha - 1} }{1 + \lambda t^\alpha }  \quad \quad  h(t|Z=1) = \frac{\alpha \lambda t^{\alpha - 1}e^{-\alpha\gamma} }{1 + \lambda t^\alpha e^{-\alpha\gamma}}
$$ 

Le risque relatif est: 

\begin{align*}
RR(t) &= \frac{h(t|Z=1)}{h(t|Z=0)} \\
&= \frac{\alpha \lambda t^{\alpha - 1}e^{-\alpha\gamma} }{1 + \lambda t^\alpha e^{-\alpha\gamma}} \left(\frac{\alpha \lambda t^{\alpha - 1} }{1 + \lambda t^\alpha } \right)^{-1} \\
&= \frac{e^{-\alpha\gamma} }{1 + \lambda t^\alpha e^{-\alpha\gamma}}  \\
&= \frac{e^{-\alpha\gamma} (1 + \lambda t^\alpha) }{1 + \lambda t^\alpha e^{-\alpha\gamma}}
\end{align*}

Qui dépend de $t$
```{r}
reg_log_cov <- survreg(Surv(time=time,event=delta)~Z, data=data, dist="loglogistic")
summary(reg_log_cov)
```
```{r}
mu_reg_log <- reg_log_cov$coefficients[1]
sigma_reg_log <- reg_log_cov$scale
alpha_reg_log <- 1 /sigma_reg_log
gamma_reg_log <- reg_log_cov$coefficients[2]
lamda_reg_log <- exp(-mu_reg_log*alpha_reg_log)

RR_t <- function(t, alpha = alpha_reg_log, gamma = gamma_reg_log, lambda =lamda_reg_log){
  num <- exp(-alpha * gamma) *(1 + lambda*t^alpha)
  den <- 1 + lambda * t^alpha *exp(-alpha*gamma)
}
```

```{r}
temps <- seq(0,40,0.1)
plot(temps, RR_t(temps))
```

